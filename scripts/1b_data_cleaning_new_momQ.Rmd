---
title: "COPE data cleaning for New Mom survey"
author: "Michelle.VanTieghem"
date: "June 2, 2020"
output:
  html_document:
    number_sections: no
    df_print: kable
    code_folding: show
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
      
---



```{r, echo = F, message = F, warning = F, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, include= F)

library(tidyverse)
library(ggplot2)
library(readxl)
```

# README
cleaning COPE survey data for further analysis \
output: cleaned baseline data for redcap instrument "cope survey all" \
removes duplicates, includes all responses, including incompletes. 

# load data
## load cleaned baseline data from script 1a
```{r}
load("clean_data/baseline_clean_df.Rdata")

```

## load Week 2 follow-up data (longitudinal project)
```{r, echo = F, message = F}

long_df <- read_csv("raw_data/COPELongitudinalStud_DATA_use.csv") %>%
  select(-contains("timestamp"))  %>%
   mutate(child_birth_date = as.character(child_birth_date), 
         birth_date = as.character(birth_date), 
         today_date = as.character(today_date),
         pregnant_due_date = as.character(pregnant_due_date),
         covid_tested_neg_date = as.character(covid_tested_neg_date),
         date_of_visit = as.character(date_of_visit),
        status = ifelse(is.na(currently_mother) & is.na(birth_update), "Pregnant", "New Mom"))%>%
  rename(baseline_date = today_date,
         fu2_date = date_of_visit) %>%
  mutate(phase = "phase2_long")

# follow-up week 2 - retain people who reported giving birth at followup
fu2_df <-long_df %>%
  filter(redcap_event_name == "covid_week_2_follo_arm_1" & birth_update == 1)
nrow(fu2_df)
```

### check N for follow-ups 
```{r, eval = F}
print(paste0("Total Records (started survey):", nrow(fu2_df)))
summary(as.factor(fu2_df$welcome_to_week_2_followup_complete))

print ("Completed all surveys:")
summary(as.factor(fu2_df$food_sec_form_complete))
```

## clean new mom data (pooling across baseline + follow ups)
```{r, echo = F}
# get demo data for all moms 
demo_data <- baseline_clean2 %>%
  select(record_id, baseline_date, 
          birth_date, 
         currently_pregnant, currently_mother,
        income_brackets, education,
         starts_with("race"), ethnicity,
         # covid testing
        contains("test"), contains ("symp"),
         #pull items of interest
        contains("treat"),
         contains("concern"),
        contains("distress"),
         contains("social"), 
         contains("drug"),
         contains("opiod"),
         starts_with("bsi"), 
         starts_with("ptsd"), 
        # make surre mom/ preg concerrn ratingns don't get pulledin
        -contains("mom"), -contains("preg"))


# extract only the mom survey part for the moms who filled out at baseline
# and only finished entire survey!
mom_data <- baseline_clean2 %>%
 filter(status == "New Mom"& covid19_survey_for_new_mothers_complete == 2) %>%
  select(record_id, baseline_date,  child_birth_date, 
         status,  starts_with("birth_plan"), starts_with("mom"), 
         starts_with("postnatal"), covid19_survey_for_new_mothers_complete) %>%
  mutate(birth_update = NA, mom_medical_vitamins = NA) %>%
  rename(new_mom_survey_date = baseline_date)
nrow(mom_data)


# who gave birth since baseline? 
# keeping only those who fully finished new mom Q.
mom_data2 <- fu2_df %>%
  filter(birth_update == 1 & covid19_survey_for_new_mothers_complete == 2) %>%
  mutate(status = "New Mom") %>%
  select(record_id, fu2_date, child_birth_date, status, birth_update,
         starts_with("birth_plan"), starts_with("mom"), 
         starts_with("postnatal"), covid19_survey_for_new_mothers_complete) %>%
  rename(new_mom_survey_date = fu2_date)
nrow(mom_data2)

```

## combine mom data
```{r, echo = F}

merge_names <- names(mom_data)[! names(mom_data) %in% names(mom_data2)]

mom_data_all <- rbind(mom_data, mom_data2) %>%
  merge(., demo_data, by = "record_id") 

nrow(mom_data) + nrow(mom_data2)

# check that no duplicate participants after merging
identical(length(unique(mom_data_all$record_id)), nrow(mom_data_all))
```

## Add coding for variables of interest
```{r, echo = F, include = F}

mom_data_all <- mom_data_all %>%
#  mutate(child_birth_date = as.Date(child_birth_date,  format="%m/%d/%Y")) %>%
  mutate(Month = as.factor(ifelse(child_birth_date >= as.Date("2020-04-15") |
                                    !is.na(birth_update), "April 15",
           ifelse(child_birth_date >= as.Date("2020-04-01"), "April 01",
           ifelse(child_birth_date >= as.Date("2020-03-15"), "March 15", 
           ifelse(child_birth_date >= as.Date("2020-03-01"), "March 01", 
         ifelse(child_birth_date >= as.Date("2020-02-15"), "Feb 15", 
           ifelse(child_birth_date >= as.Date("2020-02-01"), "Feb 01", "Before Feb"))))))), 
         During_covid = as.factor(ifelse(child_birth_date >= as.Date("2020-03-15") |
                     # some moms didn't report child birth in the week 2 update
                                           !is.na(birth_update), 1, 0)),
         
      Delivery_date = ifelse(During_covid == 0, 
                                        "Before March 15, 2020", "After March 15, 2020"),
         # because data is spread across 10 dif answers
     # make indicator for whether any change was endorsed 
       no_resp_birth_change = ifelse((birth_plan_changes___1 == 0) &
                               (birth_plan_changes___2 == 0) &
                                 (birth_plan_changes___3 == 0) &
                                 (birth_plan_changes___4 == 0) &
                                 (birth_plan_changes___5== 0) &
                                 (birth_plan_changes___6== 0) &
                                 (birth_plan_changes___7== 0) &
                                 (birth_plan_changes___8== 0) &
                                 (birth_plan_changes___9== 0) &
                                 (birth_plan_changes___10 == 0), 1, 0),
     any_birth_change = ifelse(birth_plan_changes___1 == 1 |
                               birth_plan_changes___2 == 1 |
                               birth_plan_changes___3 == 1 |
                               birth_plan_changes___4 == 1 |
                               birth_plan_changes___5 == 1 |
                               birth_plan_changes___6 == 1 |
                               birth_plan_changes___7 == 1 |
                               birth_plan_changes___8 == 1 |
                                 # option 9 = no change
                               birth_plan_changes___10 == 1, 1, 
                                      # mark people who answered none of these options as NA.
                               ifelse(no_resp_birth_change == 1, NA, 0)),
     # make prettier version for plotting  
     Birth_change_factor = as.factor(ifelse(any_birth_change == 0, "No changes", "Changes to Birth Plan")),

    no_resp_postnatal_change = ifelse(postnatal_plan_changes___1 == 0 &
                                     postnatal_plan_changes___2 ==0 &
                                   postnatal_plan_changes___3 == 0 &
                                  postnatal_plan_changes___4 == 0 &
                                  postnatal_plan_changes___5 == 0 &
                                   postnatal_plan_changes___6 == 0 &
                                   postnatal_plan_changes___7 == 0 &
                                    postnatal_plan_changes___8 == 0 &
                                     postnatal_plan_changes___9 == 0 &
                                    postnatal_plan_changes___10 == 0 &
                                     postnatal_plan_changes___11 == 0, 1, 0),
     any_postnatal_change = ifelse(postnatal_plan_changes___1 == 1 |
                                     postnatal_plan_changes___2 == 1 |
                                   postnatal_plan_changes___3 == 1 |
                                  postnatal_plan_changes___4 == 1 |
                                  postnatal_plan_changes___5 == 1 |
                                   postnatal_plan_changes___6 == 1|
                                   postnatal_plan_changes___7 == 1 |
                                    postnatal_plan_changes___8 == 1 |
                                     postnatal_plan_changes___9 == 1 |
                                    # option 10 = no change
                                     postnatal_plan_changes___11 == 1, 1,
                                  # mark people who answered none of these options as NA.
                                   ifelse(no_resp_birth_change == 1, NA, 0)),
     # make prettier version for plotting  
     Postnatal_change_factor = as.factor(ifelse(any_postnatal_change == 0, "No changes", "Changes to Postnatal care")))
```

### check variable coding
```{r}

summary(as.factor(mom_data_all$no_resp_birth_change))
summary(as.factor(mom_data_all$any_birth_change))

summary(as.factor(mom_data_all$no_resp_postnatal_change))
summary(as.factor(mom_data_all$any_postnatal_change))
```


## save cleaned data 
```{r}

save(mom_data_all, file ="clean_data/new_mom_df_clean.Rdata")
```