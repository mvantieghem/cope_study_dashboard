---
title: "COPE: dimension reduction for impact and distress"
author: "Michelle.VanTieghem"
date: "June 24, 2020"
output:
  html_document:
    number_sections: no
    df_print: kable
    code_folding: show
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes

---


```{r, echo = F, message = F, warning = F, include = F}
knitr::opts_chunk$set(message = F, warning = F)

library(psych)
# load packages
library(corrplot)
library(tidyverse)
library(ggplot2)
library(readxl)

# load custom packages
source("custom_functions.R")
```

```{r}
load("../clean_data/impact_disruption_cleaned.Rda")
```

## correlation plot 
all are positively related! 
especially concerns for medicine, food, healthcare, supplies.
```{r}

cor_vars <- cor(pred_vars_no_labels)
corrplot(cor_vars, type = "lower")

```



# Symptom scale ratings

```{r}
bsi_vars <- c("bsi_global", "bsi_depression", "bsi_anxiety", "bsi_somatization", "ptsd_ave")

bsi_df <- baseline_clean3 %>%
  select(all_of(bsi_vars), record_id) 

bsi_plot <- bsi_df %>%
  select(-record_id) %>%
  gather(key = "scale", value = "score") %>%
  ggplot(aes(x = scale, y = score)) + 
  geom_boxplot(width = .5) + theme_bw() +
  theme(legend.position = "none") +
  
   geom_jitter(alpha = 0.3, width = 0.1, height = 0.1, aes(color = scale)) 

bsi_plot
```

## correlation plots  
all super correlated! 
```{r}
# will only include pairs with no NAs
cor_vars <- cor(bsi_df, use = "pairwise.complete.obs")
corrplot(cor_vars, type = "lower")

```


# factor analysis on distress/ concern scales 
## run parallel analysis
```{r}

par_analysis <- fa.parallel(pred_vars, n.obs= nrow(pred_vars), n.iter = 100, error.bars = TRUE)
par_analysis$nfact 
```

## run factor analysis on sample
```{r}
scale_fun <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

# make input data valid format
input_cor <- pred_vars_no_labels %>%
  # standardize the data 
  mutate_if(is.numeric, scale_fun) %>%
  # convert to matrix
  as.matrix(.) %>% 
  # create correlation matrix
  cor(.)

# running a biquartimin factor analysis with 4 factors
FA_sample <- psych::fa(r = input_cor, n.iter= 100, n.obs = nrow(input_vars), nfactors = 4, 
                fm = "ML", scores = "Bartlett")

```


## organize results for plotting 
```{r}
## get eigen values
FA_eigen <- data.frame(FA_sample$e.values)
dim(FA_eigen)
names(FA_eigen) <- "eigenvalues"
FA_eigen$factors <- as.numeric(as.character(rownames(FA_eigen)))

## get variance accounted for
FA_variance <- data.frame(FA_sample$Vaccounted)
names(FA_variance) <- c(1:ncol(FA_variance))
FA_variance %>% 
  mutate(value = row.names(data.frame(FA_variance)))

## get sample loadings 
FA_loadings <- data.frame(fa.organize(FA_sample)$loadings)

FA_weights <- data.frame(FA_sample$weights)
variables <- rownames(FA_weights)
# add variable names to the loadings 
FA_loadings$variables <- variables

# get scores for each subject
weights_matrix <- FA_weights %>%
  as.matrix()

# add scores with subject record id
FA_scores <- data.frame(input_vars%*%weights_matrix) %>%
  cbind(., pred_vars$record_id) %>%
  rename(record_id = 'pred_vars$record_id')
```

## plot loadings
```{r}
FA_loadings %>%
  gather(key = factor, value = loading, -variables) %>%
  mutate(Factor_names = ifelse(factor == "ML1", "Eonomic concerns", 
                        ifelse(factor == "ML2", "Resource concerns",
                               ifelse(factor == "ML3", "Health concerns", 
                                      ifelse(factor == "ML4", "Social concerns", NA))))) %>%
  ggplot(aes(x = variables, y = loading)) + facet_wrap(~Factor_names, ncol = 4) + 
    geom_point( color = "blue") + theme_bw() + coord_flip() + 
  geom_hline(yintercept = 0, linetype = "dashed")

```

## plot scores against symptoms 
### combine data first
```{r}
# combine with bsi data 
combo_df <- FA_scores %>%
  left_join(., bsi_df, by = "record_id") 

# make a long version
combo_long <- combo_df %>%
  gather(key = factor, value = score, -all_of(names(bsi_df))) %>%
  mutate(Factor_names = ifelse(factor == "ML1", "Eonomic concerns", 
                          ifelse(factor == "ML2", "Resource concerns",
                               ifelse(factor == "ML3", "Health concerns", 
                                      ifelse(factor == "ML4", "Social concerns", NA)))))
```


```{r}
# plot
BSI_global_plot <- combo_long %>%
  ggplot(aes(x = score, y = bsi_global)) + 
  geom_point( alpha = 0.2) + theme_bw() +
  geom_smooth(method = "lm", color = "blue") +
  facet_grid(~Factor_names) + ylab ("BSI Global Symptom Scale")
BSI_global_plot 
```

```{r}
# plot
ptsd_plot <- combo_long %>%
  ggplot(aes(x = score, y = ptsd_ave)) + 
  geom_point( alpha = 0.2) + theme_bw() +
  geom_smooth(method = "lm", color = "blue") +
  facet_grid(~Factor_names) + ylab ("PTSD Symptom Scale")
ptsd_plot
```

```{r}
# plot
BSI_depress_plot <- combo_long %>%
  ggplot(aes(x = score, y = bsi_depression)) + 
  geom_point( alpha = 0.2) + theme_bw() +
  geom_smooth(method = "lm", color = "blue") +
  facet_grid(~Factor_names) + ylab ("BSI Depression Sub-scale")
BSI_depress_plot 
```

```{r}
# plot
BSI_anxiety_plot <- combo_long %>%
  ggplot(aes(x = score, y = bsi_global)) + 
  geom_point( alpha = 0.2) + theme_bw() +
  geom_smooth(method = "lm", color = "blue") +
  facet_grid(~Factor_names) + ylab ("BSI Anxiety Sub-Scale")
BSI_anxiety_plot
```

## regression
```{r}

lm_fit <- lm(bsi_global ~ ML1 + ML2 + ML3 + ML4, data = combo_df)
summary(lm_fit)
```